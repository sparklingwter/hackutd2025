rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // Helper Functions
    // ========================================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the document (document ID matches user ID)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is trying to create/update only their own data
    function isOwnerInData() {
      return isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // ========================================================================
    // Vehicles Collection (Public Read, Admin Write Only)
    // ========================================================================
    
    match /vehicles/{vehicleId} {
      // Anyone can read vehicle data (public catalog)
      allow read: if true;
      
      // Only admins can write (handled via Firebase Admin SDK server-side)
      allow write: if false;
      
      // Trims subcollection
      match /trims/{trimId} {
        // Anyone can read trim data
        allow read: if true;
        
        // Only admins can write
        allow write: if false;
      }
    }
    
    // ========================================================================
    // User Profiles Collection (Owner Read/Write)
    // ========================================================================
    
    match /userProfiles/{userId} {
      // Users can only read their own profile
      allow read: if isOwner(userId);
      
      // Users can only create/update their own profile
      // Must include required fields: email, favorites, savedSearches, savedCompareSets, savedEstimates
      allow create: if isOwner(userId)
        && request.resource.data.keys().hasAll(['email', 'favorites', 'savedSearches', 'savedCompareSets', 'savedEstimates'])
        && request.resource.data.email is string
        && request.resource.data.favorites is list
        && request.resource.data.savedSearches is list
        && request.resource.data.savedCompareSets is list
        && request.resource.data.savedEstimates is list;
      
      // Users can update their own profile
      allow update: if isOwner(userId);
      
      // Users can delete their own profile
      allow delete: if isOwner(userId);
    }
    
    // ========================================================================
    // Dealer Leads Collection (Owner Create/Read)
    // ========================================================================
    
    match /dealerLeads/{leadId} {
      // Users can only read their own leads
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can create leads with their own userId
      // Must include: userId, vehicleIds, contactInfo, zipCode, consent
      // Consent must be literally true
      allow create: if isOwnerInData()
        && request.resource.data.keys().hasAll(['userId', 'vehicleIds', 'contactInfo', 'zipCode', 'consent'])
        && request.resource.data.vehicleIds is list
        && request.resource.data.vehicleIds.size() > 0
        && request.resource.data.vehicleIds.size() <= 10
        && request.resource.data.contactInfo.keys().hasAll(['name', 'email', 'phone', 'preferredContact'])
        && request.resource.data.zipCode is string
        && request.resource.data.zipCode.matches('^[0-9]{5}$')
        && request.resource.data.consent == true;
      
      // Users cannot update or delete leads (immutable once created)
      allow update, delete: if false;
    }
    
    // ========================================================================
    // Default Deny All Other Collections
    // ========================================================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}